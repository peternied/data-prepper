properties([
  parameters([
    string(
        name: 'DistManifestUrl',
        description: 'The url to distribution manifest for this release')])
])

lib = library(
    identifier: 'jenkins@uni-poc',
    retriever:modernSCM(
        [$class: 'GitSCMSource',
        remote: 'https://github.com/peternied/opensearch-build.git',
        traits: [gitBranchDiscovery()]
        ])
    )

Map config = [
    cleanup: { -> echo "Totally unneed clean for demo purposes"}
]

standardReleasePipeline(config) {
    def distManifest = new FakeDistManifest(fakeYmlFromUrl(params.DistManifestUrl))

    def downloadPath = fakeDownloadArtifacts(distManifest)

    // Signing workflow
    fakeSignArtifacts(
        artifactsPath: downloadPath,
        signatureType: '.sig',
        distributionPlatform: 'linux',
    )
    
    // Replace with publishToMaven(...)
    fakeWithCredentials {
        sh('$WORKSPACE/publish/publish-snapshot.sh $WORKSPACE/dist/${distManifest.product}/maven')
    }

    // Replace with publishToArtifactRepositry(...)
    fakeWithAWS {
        s3Upload(file: 'distribution/', bucket: "${ARTIFACT_PRODUCTION_BUCKET_NAME}", path: "${distManifest.product}/${distManifest.version}/")
    }

    fakeCopyDockerImage(
        sourceImagePath: distManifest.artifacts.containerReference,
        destinationImagePath: "opensearchproject/${distManifest.product}:${distManifest.version}",
        destinationType: "docker",
        destinationCredentialIdentifier: "jenkins-staging-docker-prod-token"
    )
}

/////////////////////////////////////////////////////////////////////////////////////
// Fakes were written to make sure POC could be executed against jenkins environment

class FakeDistManifest implements Serializable {
    // Additional contents need to be added to the dist manifest for
    // these parameters
    class Artifacts implements Serializable {
        String containerReference
        Artifacts(Map data) {
            this.containerReference = data?.containerReference
        }
    }

    Artifacts artifacts
    String product
    String version
    FakeDistManifest(Map data) {
        println "new DisManifest: ${data}"
        this.artifacts = new Artifacts(data?.artifacts)
        this.product = data?.product
        this.version = data?.product
    }
}

Map fakeYmlFromUrl(String url) {
    echo "ymlFromUrl: ${url}"
    return [:]
}

def fakeDownloadArtifacts(FakeDistManifest manifest) {
    echo "fakeDownloadArtifacts"

}

def fakeSignArtifacts(Map args) {
    echo "fakeDownloadArtifacts ${args}"
}

def fakeWithCredentials(Closure closure) {
    echo "fakeWithCredentials, not running inner closure"
}

def fakeWithAWS(Closure closure) {
    echo "fakeWithAWS, not running inner closure"
}

def fakeCopyDockerImage(Map args) {
    echo "fakeCopyDockerImage ${args}"
}